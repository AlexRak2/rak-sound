<Window x:Class="SonnissBrowser.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sonnissBrowser="clr-namespace:SonnissBrowser"
        xmlns:local="clr-namespace:SonnissBrowser"
        xmlns:shell="http://schemas.microsoft.com/winfx/2006/xaml/presentation/shell"
        Title="RakSound"
        Width="1500" Height="860"
        WindowStartupLocation="CenterScreen"
        Background="#1E1E1E"
        WindowStyle="None"
        ResizeMode="CanResize"
        AllowsTransparency="False"
        Icon="Assets/app.ico"
        Loaded="Window_Loaded"
        StateChanged="Window_StateChanged"
        PreviewKeyDown="Window_PreviewKeyDown">


    <Window.Resources>
        
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Soundly Color Palette -->
        <SolidColorBrush x:Key="Bg0" Color="#1E1E1E"/>
        <SolidColorBrush x:Key="Bg1" Color="#252526"/>
        <SolidColorBrush x:Key="Bg2" Color="#2D2D30"/>
        <SolidColorBrush x:Key="Panel" Color="#252526"/>
        <SolidColorBrush x:Key="Border" Color="#333337"/>
        <SolidColorBrush x:Key="HeaderBg" Color="#323233"/>
        <SolidColorBrush x:Key="Text0" Color="#CCCCCC"/>
        <SolidColorBrush x:Key="Text1" Color="#BBBBBB"/>
        <SolidColorBrush x:Key="Text2" Color="#858585"/>
        <SolidColorBrush x:Key="Text3" Color="#6A6A6A"/>
        <SolidColorBrush x:Key="Accent" Color="#0E639C"/>
        <SolidColorBrush x:Key="AccentBright" Color="#007ACC"/>
        <SolidColorBrush x:Key="Selection" Color="#094771"/>

        <!-- Ultra-thin scrollbars (Soundly style) -->
        <Style TargetType="{x:Type ScrollBar}">
            <Setter Property="Width" Value="6"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid Background="Transparent">
                            <Track x:Name="PART_Track" IsDirectionReversed="False">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="ScrollBar.LineUpCommand" Opacity="0" IsHitTestVisible="False"/>
                                </Track.DecreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Background="#3E3E42" Opacity="0.4">
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="Thumb">
                                                <Border x:Name="ThumbBorder" 
                                                        CornerRadius="3" 
                                                        Background="{TemplateBinding Background}" 
                                                        Margin="1"/>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="ThumbBorder" Property="Background" Value="#686868"/>
                                                        <Setter TargetName="ThumbBorder" Property="Opacity" Value="0.7"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="ScrollBar.LineDownCommand" Opacity="0" IsHitTestVisible="False"/>
                                </Track.IncreaseRepeatButton>
                            </Track>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="Orientation" Value="Horizontal">
                                <Setter Property="Height" Value="6"/>
                                <Setter Property="Width" Value="Auto"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        
        <!-- Compact Button Styles -->
        <Style TargetType="Button" x:Key="Btn">
            <Setter Property="Background" Value="#3F3F46"/>
            <Setter Property="Foreground" Value="{StaticResource Text0}"/>
            <Setter Property="BorderBrush" Value="#555555"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="3"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#505055"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#5A5A5F"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.4"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Button" x:Key="BtnAccent" BasedOn="{StaticResource Btn}">
            <Setter Property="Background" Value="{StaticResource AccentBright}"/>
            <Setter Property="BorderBrush" Value="{StaticResource AccentBright}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="3"
                                Background="{TemplateBinding Background}"
                                BorderThickness="0">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#1C97EA"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#2AA0F0"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Compact TextBox -->
        <Style TargetType="TextBox" x:Key="SearchBox">
            <Setter Property="Background" Value="#3C3C3C"/>
            <Setter Property="Foreground" Value="{StaticResource Text0}"/>
            <Setter Property="BorderBrush" Value="#555555"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3">
                            <ScrollViewer x:Name="PART_ContentHost" 
                                          Margin="2"
                                          VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="#6A6A6A"/>
                            </Trigger>
                            <Trigger Property="IsFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentBright}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Compact ListView -->
        <Style TargetType="ListView" x:Key="List">
            <Setter Property="Background" Value="{StaticResource Bg1}"/>
            <Setter Property="Foreground" Value="{StaticResource Text0}"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>

        <Style TargetType="ListViewItem">
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Height" Value="22"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderThickness="0"
                                Padding="{TemplateBinding Padding}">
                            <GridViewRowPresenter Content="{TemplateBinding Content}"
                                                  Columns="{TemplateBinding GridView.ColumnCollection}"
                                                  VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#2A2D2E"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource Selection}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Small Grey Headers (Soundly style) -->
        <Style TargetType="{x:Type GridViewColumnHeader}">
            <Setter Property="Background" Value="{StaticResource HeaderBg}"/>
            <Setter Property="Foreground" Value="{StaticResource Text2}"/>
            <Setter Property="BorderBrush" Value="#3F3F46"/>
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="Normal"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type GridViewColumnHeader}">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}">
                            <TextBlock Text="{TemplateBinding Content}"
                                       Foreground="{TemplateBinding Foreground}"
                                       FontSize="{TemplateBinding FontSize}"
                                       FontWeight="{TemplateBinding FontWeight}"
                                       VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Compact TreeView -->
        <Style TargetType="TreeView">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource Text0}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>

<Style TargetType="TreeViewItem">
    <Setter Property="Foreground" Value="{StaticResource Text1}"/>
    <Setter Property="Background" Value="Transparent"/>
    <Setter Property="Padding" Value="6,3"/>
    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
    <Setter Property="Template">
        <Setter.Value>
            <ControlTemplate TargetType="TreeViewItem">
                <Grid>
                    <!-- ✅ FIX: real row layout -->
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- ✅ FIX: expander + header columns -->
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="18"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Expander -->
                    <ToggleButton x:Name="Expander"
                                  Grid.Row="0"
                                  Grid.Column="0"
                                  Width="14"
                                  Height="14"
                                  Margin="2,3,2,0"
                                  IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                  ClickMode="Press"
                                  Focusable="False"
                                  Background="Transparent"
                                  BorderThickness="0"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center">
                        <Border x:Name="ExpanderBox"
                                Width="14"
                                Height="14"
                                Background="#3E3E42"
                                CornerRadius="2">
                            <TextBlock x:Name="Glyph"
                                       Text="+"
                                       FontSize="12"
                                       Foreground="{StaticResource Text0}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Margin="0,-1,0,0"/>
                        </Border>
                    </ToggleButton>

                    <!-- Header -->
                    <Border x:Name="Bd"
                            Grid.Row="0"
                            Grid.Column="1"
                            Background="{TemplateBinding Background}"
                            Padding="{TemplateBinding Padding}">
                        <ContentPresenter x:Name="PART_Header"
                                          ContentSource="Header"
                                          HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                          VerticalAlignment="Center"/>
                    </Border>

                    <!-- Children -->
                    <ItemsPresenter x:Name="ItemsHost"
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    Margin="18,0,0,0"/>

                </Grid>

                <ControlTemplate.Triggers>
                    <Trigger Property="IsExpanded" Value="False">
                        <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed"/>
                    </Trigger>

                    <Trigger Property="IsExpanded" Value="True">
                        <Setter TargetName="Glyph" Property="Text" Value="−"/>
                    </Trigger>

                    <Trigger Property="HasItems" Value="False">
                        <Setter TargetName="Expander" Property="Visibility" Value="Hidden"/>
                    </Trigger>

                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter TargetName="Bd" Property="Background" Value="#2A2D2E"/>
                    </Trigger>

                    <Trigger Property="IsSelected" Value="True">
                        <Setter TargetName="Bd" Property="Background" Value="{StaticResource Selection}"/>
                        <Setter Property="Foreground" Value="{StaticResource Text0}"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </Setter.Value>
    </Setter>
</Style>

        <!-- Compact Sliders -->
        <Style TargetType="Slider" x:Key="Timeline">
            <Setter Property="Height" Value="20"/>
            <Setter Property="Margin" Value="8,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid>
                            <Border Height="3"
                                    Background="#3E3E42"
                                    CornerRadius="1.5"
                                    VerticalAlignment="Center"/>
                            <Track x:Name="PART_Track">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="Slider.DecreaseLarge">
                                        <RepeatButton.Template>
                                            <ControlTemplate TargetType="RepeatButton">
                                                <Border Height="3" 
                                                        Background="{StaticResource AccentBright}"
                                                        CornerRadius="1.5,0,0,1.5"/>
                                            </ControlTemplate>
                                        </RepeatButton.Template>
                                    </RepeatButton>
                                </Track.DecreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Width="12" Height="12">
                                        <Thumb.Template>
                                            <ControlTemplate>
                                                <Ellipse x:Name="ThumbEllipse" 
                                                         Fill="{StaticResource AccentBright}"/>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="ThumbEllipse" Property="Fill" Value="#1C97EA"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="Slider.IncreaseLarge">
                                        <RepeatButton.Template>
                                            <ControlTemplate TargetType="RepeatButton">
                                                <Border Background="Transparent"/>
                                            </ControlTemplate>
                                        </RepeatButton.Template>
                                    </RepeatButton>
                                </Track.IncreaseRepeatButton>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Slider" x:Key="VolumeSlider">
            <Setter Property="Height" Value="20"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid>
                            <Border Height="3"
                                    Background="#3E3E42"
                                    CornerRadius="1.5"
                                    VerticalAlignment="Center"/>
                            <Track x:Name="PART_Track">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="Slider.DecreaseLarge">
                                        <RepeatButton.Template>
                                            <ControlTemplate TargetType="RepeatButton">
                                                <Border Height="3" 
                                                        Background="{StaticResource AccentBright}"
                                                        CornerRadius="1.5,0,0,1.5"/>
                                            </ControlTemplate>
                                        </RepeatButton.Template>
                                    </RepeatButton>
                                </Track.DecreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Width="10" Height="10">
                                        <Thumb.Template>
                                            <ControlTemplate>
                                                <Ellipse Fill="{StaticResource AccentBright}"/>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="Slider.IncreaseLarge">
                                        <RepeatButton.Template>
                                            <ControlTemplate TargetType="RepeatButton">
                                                <Border Background="Transparent"/>
                                            </ControlTemplate>
                                        </RepeatButton.Template>
                                    </RepeatButton>
                                </Track.IncreaseRepeatButton>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CaptionBtn" TargetType="Button">
            <Setter Property="Width" Value="46"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#DDDDDD"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#2A2A2A"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#3A3A3A"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CaptionBtnClose" TargetType="Button" BasedOn="{StaticResource CaptionBtn}">
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#C42B1C"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#A52317"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        
    </Window.Resources>
    
    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="32"
                      CornerRadius="0"
                      GlassFrameThickness="0"
                      ResizeBorderThickness="6"
                      UseAeroCaptionButtons="False"/>
    </WindowChrome.WindowChrome>


    <Grid>
        <!--ENTIRE UI-->
        <DockPanel LastChildFill="True">

        
        <!-- CUSTOM TITLE BAR -->
        <!-- CUSTOM TITLE BAR -->
        <Border DockPanel.Dock="Top"
                Height="32"
                Background="#111111"
                BorderBrush="#2A2A2A"
                BorderThickness="0,0,0,1">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- DRAG AREA -->
                <Border Grid.Column="0"
                        Background="Transparent"
                        MouseLeftButtonDown="TitleBar_MouseLeftButtonDown"
                        WindowChrome.IsHitTestVisibleInChrome="True">
                    <StackPanel Orientation="Horizontal"
                                Margin="10,0,0,0"
                                VerticalAlignment="Center">

                        <Image Width="16"
                               Height="16"
                               Margin="0,0,8,0"
                               Source="Assets/app.ico"
                               SnapsToDevicePixels="True"/>

                        <TextBlock Text="RakSound"
                                   VerticalAlignment="Center"
                                   Foreground="#DDDDDD"
                                   FontSize="12"
                                   FontWeight="SemiBold"/>
                    </StackPanel>

                </Border>

                <!-- BUTTONS (must be hit-testable inside chrome) -->
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            WindowChrome.IsHitTestVisibleInChrome="True">

                    <Button Style="{StaticResource CaptionBtn}"
                            Content="—"
                            Click="Minimize_Click">
                        <WindowChrome.IsHitTestVisibleInChrome>True</WindowChrome.IsHitTestVisibleInChrome>
                    </Button>

                    <Button Style="{StaticResource CaptionBtn}"
                            Content="▢"
                            Click="MaxRestore_Click"
                            WindowChrome.IsHitTestVisibleInChrome="True"/>

                    <Button Style="{StaticResource CaptionBtnClose}"
                            Content="✕"
                            Click="Close_Click"
                            WindowChrome.IsHitTestVisibleInChrome="True"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- TOP BAR -->
        <Border DockPanel.Dock="Top"
                Background="{StaticResource Bg1}"
                BorderBrush="{StaticResource Border}"
                BorderThickness="0,0,0,1"
                Padding="12,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="240"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Image Width="18"
                           Height="18"
                           Margin="0,0,8,0"
                           Source="Assets/app.ico"
                           SnapsToDevicePixels="True"/>

                    <TextBlock Text="RakSound" 
                               Foreground="{StaticResource Text0}" 
                               FontSize="13" 
                               FontWeight="SemiBold"/>
                </StackPanel>


                <!-- Search -->
                <TextBox Grid.Column="1"
                         Style="{StaticResource SearchBox}"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Margin="12,0"
                         ToolTip="Search"/>

                <!-- Choose folder -->
                <Button Grid.Column="2"
                        Style="{StaticResource BtnAccent}"
                        Content="Choose Folder"
                        Command="{Binding ChooseFolderCommand}"
                        Margin="0,0,8,0"/>

                <!-- Status -->
                <TextBlock Grid.Column="3"
                           Text="{Binding StatusText}"
                           Foreground="{StaticResource Text2}"
                           FontSize="10"
                           VerticalAlignment="Center"/>
            </Grid>
        </Border>


        <!-- FULL-WIDTH WAVEFORM STRIP (above bottom transport) -->


        
        <!-- BOTTOM TRANSPORT BAR -->
<!-- BOTTOM TRANSPORT BAR -->
<Border DockPanel.Dock="Bottom"
        Background="{StaticResource Bg1}"
        BorderBrush="{StaticResource Border}"
        BorderThickness="0,1,0,0"
        Padding="12,10">

    <Grid Height="64">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Transport Buttons -->
        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <Button Style="{StaticResource Btn}"
                    Width="80"
                    Content="{Binding PlayButtonText}"
                    Command="{Binding PlaySelectedCommand}"/>

            <Button Style="{StaticResource Btn}"
                    Width="60"
                    Margin="8,0,0,0"
                    Content="Stop"
                    Command="{Binding StopCommand}"/>
        </StackPanel>

        <!-- Now Playing + Timeline + Actions -->
        <Grid Grid.Column="1" Margin="16,0" VerticalAlignment="Center">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="6"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Now Playing Info -->
            <DockPanel Grid.Row="0" LastChildFill="False">
                <TextBlock Text="{Binding NowPlayingTitle}"
                           Foreground="{StaticResource Text0}"
                           FontSize="11"
                           TextTrimming="CharacterEllipsis"/>

                <TextBlock Text="  •  "
                           Foreground="{StaticResource Text3}"
                           FontSize="11"
                           Margin="6,0"/>

                <TextBlock Text="{Binding NowPlayingSubtitle}"
                           Foreground="{StaticResource Text2}"
                           FontSize="11"
                           TextTrimming="CharacterEllipsis"/>
            </DockPanel>

            <!-- Timeline row -->
            <Grid Grid.Row="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="70"/>
                    <ColumnDefinition Width="Auto"/> <!-- Set Export Folder -->
                    <ColumnDefinition Width="Auto"/> <!-- Export -->
                    <ColumnDefinition Width="Auto"/> <!-- Clear -->
                </Grid.ColumnDefinitions>


                <TextBlock Text="{Binding ElapsedText}"
                           Foreground="{StaticResource Text2}"
                           FontSize="10"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Left"/>

                <Slider Grid.Column="1"
                        Style="{StaticResource Timeline}"
                        Minimum="0"
                        Maximum="{Binding DurationSeconds}"
                        Value="{Binding PositionSeconds, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        IsEnabled="{Binding HasMedia}"
                        PreviewMouseLeftButtonDown="Timeline_MouseDown"
                        PreviewMouseLeftButtonUp="Timeline_MouseUp"/>

                <TextBlock Grid.Column="2"
                           Text="{Binding DurationText}"
                           Foreground="{StaticResource Text2}"
                           FontSize="10"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Right"/>

                <Button Grid.Column="3"
                        Style="{StaticResource Btn}"
                        Content="Set Export Folder"
                        Margin="10,0,0,0"
                        Command="{Binding ChooseExportFolderCommand}"/>

                <Button Grid.Column="4"
                        Style="{StaticResource Btn}"
                        Content="Export"
                        Margin="8,0,0,0"
                        Command="{Binding ExportSelectionCommand}"
                        IsEnabled="{Binding HasSelection}"/>

                <Button Grid.Column="5"
                        Style="{StaticResource Btn}"
                        Content="Clear"
                        Margin="8,0,0,0"
                        Command="{Binding ClearSelectionCommand}"
                        IsEnabled="{Binding HasSelection}"/>

            </Grid>
        </Grid>

        <!-- Volume Control -->
        <StackPanel Grid.Column="2"
                    Orientation="Horizontal"
                    VerticalAlignment="Center"
                    Margin="16,0,0,0">
            <TextBlock Text="Vol"
                       Foreground="{StaticResource Text2}"
                       VerticalAlignment="Center"
                       FontSize="10"
                       Margin="0,0,8,0"/>
            <Slider Style="{StaticResource VolumeSlider}"
                    Minimum="0"
                    Maximum="1"
                    Value="{Binding Volume, Mode=TwoWay}"
                    Width="110"/>
        </StackPanel>
    </Grid>
</Border>
        <Border DockPanel.Dock="Bottom"
                Background="{StaticResource Bg1}"
                BorderBrush="{StaticResource Border}"
                BorderThickness="0,1,0,0"
                Padding="12,10">

            <sonnissBrowser:WaveformControl
                Peaks="{Binding WavePeaks}"
                DurationSeconds="{Binding DurationSeconds}"
                PositionSeconds="{Binding PositionSeconds}"
                SelectionStartSeconds="{Binding SelectionStartSeconds}"
                SelectionEndSeconds="{Binding SelectionEndSeconds}"
                AccentBrush="{StaticResource AccentBright}"
                SelectionBrush="{StaticResource Selection}"
                BackgroundBrush="#1B1B1C"
                BorderBrush="#333337"
                BorderThickness="1"
                CornerRadius="3"
                Height="70"
                PreviewMouseLeftButtonDown="Wave_MouseDown"
                PreviewMouseMove="Wave_MouseMove"
                PreviewMouseLeftButtonUp="Wave_MouseUp"/>
        </Border>
        <!-- MAIN CONTENT AREA -->
        <Grid Margin="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="240"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="320"/>
            </Grid.ColumnDefinitions>

            <!-- LEFT PANEL: Libraries -->
            <Border Grid.Column="0"
                    Background="{StaticResource Panel}"
                    BorderBrush="{StaticResource Border}"
                    BorderThickness="0,0,1,0"
                    Padding="8">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               Text="LIBRARIES"
                               Foreground="{StaticResource Text3}"
                               FontSize="9"
                               FontWeight="SemiBold"
                               Margin="6,4,0,8"/>

                    <TreeView ItemsSource="{Binding CategoryTree}"
                              SelectedItemChanged="CategoryTree_SelectedItemChanged">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <TextBlock Text="{Binding DisplayName}" />
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>


                </DockPanel>
            </Border>
            <!-- MIDDLE PANEL: Sound List -->
            <Border Grid.Column="1"
                    Background="{StaticResource Bg1}"
                    BorderBrush="{StaticResource Border}"
                    BorderThickness="0,0,1,0">

                <ListView Style="{StaticResource List}"
                          ItemsSource="{Binding SoundsView}"
                          SelectedItem="{Binding Selected}"
                          SelectionMode="Extended"
                          local:ListViewSelectedItemsBehavior.SelectedItems="{Binding SelectedItems}"
                          MouseDoubleClick="ListView_MouseDoubleClick">


                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Name" Width="720" DisplayMemberBinding="{Binding FileName}" />
                            <GridViewColumn Header="Category" Width="260" DisplayMemberBinding="{Binding EffectiveCategory}" />
                            <GridViewColumn Header="Library" Width="260" DisplayMemberBinding="{Binding Category}" />
                        </GridView>
                    </ListView.View>
                </ListView>
            </Border>

            <!-- RIGHT PANEL: Sound List -->
    <!-- RIGHT PANEL: Details -->
    <Border Grid.Column="2"
            Background="{StaticResource Panel}"
            BorderBrush="{StaticResource Border}"
            BorderThickness="1,0,0,0"
            Padding="10">

        <DockPanel>
            <TextBlock DockPanel.Dock="Top"
                       Text="DETAILS"
                       Foreground="{StaticResource Text3}"
                       FontSize="9"
                       FontWeight="SemiBold"
                       Margin="6,4,0,8"/>

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>

                    <TextBlock Text="{Binding Selected.FileName}"
                               Foreground="{StaticResource Text0}"
                               FontSize="12"
                               FontWeight="SemiBold"
                               TextWrapping="Wrap"/>

                    <TextBlock Text="{Binding Selected.FullPath}"
                               Foreground="{StaticResource Text2}"
                               FontSize="10"
                               Margin="0,4,0,12"
                               TextWrapping="Wrap"/>

                    <!-- BULK EDIT (shows when selecting 2+ items) -->
                    <Border Background="#1F1F20"
                            BorderBrush="#333337"
                            BorderThickness="1"
                            CornerRadius="3"
                            Padding="8"
                            Margin="0,0,0,10"
                            Visibility="{Binding HasMultiSelection, Converter={StaticResource BooleanToVisibilityConverter}}">

                        <StackPanel>
                            <TextBlock Text="Bulk edit"
                                       Foreground="{StaticResource Text3}"
                                       FontSize="10"
                                       Margin="0,0,0,6"/>

                            <TextBlock Text="{Binding SelectedItems.Count, StringFormat=Selected: {0}}"
                                       Foreground="{StaticResource Text1}"
                                       FontSize="10"
                                       Margin="0,0,0,6"/>

                            <TextBlock Text="Set Category for selection"
                                       Foreground="{StaticResource Text3}"
                                       FontSize="10"
                                       Margin="0,0,0,4"/>

                            <ComboBox ItemsSource="{Binding CategoryOptions}"
                                      Text="{Binding BulkCategory, UpdateSourceTrigger=PropertyChanged}"
                                      IsEditable="True"
                                      Height="28"
                                      Background="#3C3C3C"
                                      Foreground="{StaticResource Text0}"
                                      BorderBrush="#555555"
                                      BorderThickness="1"
                                      Padding="6,2"/>

                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <Button Style="{StaticResource Btn}"
                                        Content="Apply"
                                        Width="80"
                                        Command="{Binding ApplyCategoryToSelectionCommand}"/>

                                <Button Style="{StaticResource Btn}"
                                        Content="Clear"
                                        Width="80"
                                        Margin="8,0,0,0"
                                        Command="{Binding ClearCategoryForSelectionCommand}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    
                    <!-- Category override -->
                    <TextBlock Text="Category"
                               Foreground="{StaticResource Text3}"
                               FontSize="10"
                               Margin="0,0,0,4"/>

                    <ComboBox ItemsSource="{Binding CategoryOptions}"
                              Text="{Binding Selected.ManualCategory, UpdateSourceTrigger=PropertyChanged}"
                              IsEditable="True"
                              Height="28"
                              Background="#3C3C3C"
                              Foreground="{StaticResource Text0}"
                              BorderBrush="#555555"
                              BorderThickness="1"
                              Padding="6,2"/>

                    <StackPanel Orientation="Horizontal" Margin="0,8,0,14">
                        <Button Style="{StaticResource Btn}"
                                Content="Clear Override"
                                Command="{Binding ClearManualCategoryCommand}"
                                IsEnabled="{Binding Selected.IsManuallyCategorized}"
                                Width="120"/>
                    </StackPanel>

                    <!-- Inferred info -->
                    <TextBlock Text="Inferred"
                               Foreground="{StaticResource Text3}"
                               FontSize="10"
                               Margin="0,0,0,4"/>

                    <TextBlock Text="{Binding Selected.SmartCategory}"
                               Foreground="{StaticResource Text0}"
                               FontSize="11"/>

                    <TextBlock Text="{Binding Selected.SmartConfidence, StringFormat=Confidence: {0:P0}}"
                               Foreground="{StaticResource Text2}"
                               FontSize="10"
                               Margin="0,0,0,14"/>

                    <!-- Metadata -->
                    <TextBlock Text="Metadata"
                               Foreground="{StaticResource Text3}"
                               FontSize="10"
                               Margin="0,0,0,6"/>

                    <TextBlock Text="{Binding Selected.Meta.DurationSeconds, StringFormat=Duration: {0:0.00}s}"
                               Foreground="{StaticResource Text1}" FontSize="10"/>

                    <TextBlock Text="{Binding Selected.Meta.SampleRate, StringFormat=Sample Rate: {0} Hz}"
                               Foreground="{StaticResource Text1}" FontSize="10"/>

                    <TextBlock Text="{Binding Selected.Meta.Channels, StringFormat=Channels: {0}}"
                               Foreground="{StaticResource Text1}" FontSize="10"/>

                    <TextBlock Text="{Binding Selected.Meta.BitsPerSample, StringFormat=Bit Depth: {0}}"
                               Foreground="{StaticResource Text1}" FontSize="10"/>

                    <TextBlock Text="{Binding Selected.Meta.FileSizeBytes, StringFormat=Size: {0:n0} bytes}"
                               Foreground="{StaticResource Text1}" FontSize="10"/>

                    <TextBlock Text="{Binding Selected.Meta.LastWriteTime, StringFormat=Modified: {0}}"
                               Foreground="{StaticResource Text1}" FontSize="10"/>

                </StackPanel>
            </ScrollViewer>
        </DockPanel>
    </Border>
        </Grid>

    </DockPanel>
        
        <!-- LOADING OVERLAY (blocks UI) -->
        <Border Background="#CC0F0F10"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                Panel.ZIndex="9999">
            <Grid HorizontalAlignment="Center" VerticalAlignment="Center" Width="520">
                <Border Background="#252526" BorderBrush="#333337" BorderThickness="1" CornerRadius="6" Padding="18">
                    <StackPanel>
                        <TextBlock Text="RakSound"
                                   Foreground="{StaticResource Text0}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,8"/>

                        <TextBlock Text="{Binding LoadingText}"
                                   Foreground="{StaticResource Text2}"
                                   FontSize="11"
                                   Margin="0,0,0,12"
                                   TextWrapping="Wrap"/>

                        <ProgressBar Height="10"
                                     Minimum="0"
                                     Maximum="1"
                                     Value="{Binding LoadingProgress, Mode=OneWay}"
                                     Background="#1B1B1C"/>


                        <TextBlock Text="{Binding LoadingPercentText}"
                                   Foreground="{StaticResource Text3}"
                                   FontSize="10"
                                   HorizontalAlignment="Right"
                                   Margin="0,6,0,0"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>

</Window>
